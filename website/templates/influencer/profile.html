{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load video_filters %} {# Assuming you have a custom video_filters.py for youtube_id #}

{% block content %}
    <div class="main flex-grow">
        {# Influencer Header Section #}
        <div class="influencer-header bg-white rounded-2xl p-8 shadow-md mb-8 flex flex-col items-center gap-8 md:flex-row md:text-left">
            {# Profile Image #}
            {% if influencer.profile_pic %}
                <img src="{{ influencer.profile_pic.url }}" alt="{{ influencer.name }}" class="influencer-image w-52 h-52 object-cover rounded-full border-5 border-primary-light">
            {% else %}
                <img src="{% static 'images/default_profile.png' %}" alt="Default Profile Image" class="influencer-image w-52 h-52 object-cover rounded-full border-5 border-primary-light">
            {% endif %}
            
            <div class="influencer-info flex-1">
                <h1 class="influencer-name text-4xl font-bold mb-2 text-primary">{{ influencer.name }}</h1>
                {% if influencer.nickname %}
                    <p class="text-lg text-text-light mb-2">"{{ influencer.nickname }}"</p>
                {% endif %}
                
                {% if influencer.profile_summary %}
                    <p class="influencer-summary text-text-light my-3 leading-relaxed font-medium">{{ influencer.profile_summary }}</p>
                {% endif %}

                <div class="stats-grid grid grid-cols-2 gap-4 my-6 md:grid-cols-4">
                    {% if influencer.instagram_followers %}
                    <div class="stat-card group bg-light text-text rounded-xl p-4 text-center transition-all duration-300 hover:bg-primary hover:text-white">
                        <div class="stat-value text-2xl font-bold mb-1">{{ influencer.instagram_followers|intcomma }}</div>
                        <div class="stat-label text-text-light text-sm group-hover:text-white group-hover:opacity-90">Followers</div>
                    </div>
                    {% endif %}
                    
                    {% if influencer.estimated_net_worth %}
                    <div class="stat-card group bg-light text-text rounded-xl p-4 text-center transition-all duration-300 hover:bg-primary hover:text-white">
                        <div class="stat-value text-2xl font-bold mb-1">${{ influencer.estimated_net_worth|intcomma }}</div>
                        <div class="stat-label text-text-light text-sm group-hover:text-white group-hover:opacity-90">Net Worth</div>
                    </div>
                    {% endif %}
                    
                    {% if influencer.age %}
                    <div class="stat-card group bg-light text-text rounded-xl p-4 text-center transition-all duration-300 hover:bg-primary hover:text-white">
                        <div class="stat-value text-2xl font-bold mb-1">{{ influencer.age }}</div>
                        <div class="stat-label text-text-light text-sm group-hover:text-white group-hover:opacity-90">Age</div>
                    </div>
                    {% endif %}
                    
                    {% if influencer.profession %}
                    <div class="stat-card group bg-light text-text rounded-xl p-4 text-center transition-all duration-300 hover:bg-primary hover:text-white">
                        <div class="stat-value text-xl font-bold mb-1">{{ influencer.profession }}</div>
                        <div class="stat-label text-text-light text-sm group-hover:text-white group-hover:opacity-90">Profession</div>
                    </div>
                    {% endif %}
                </div>

                <div class="social-links flex gap-3 my-5 justify-center md:justify-start">
                    {% if influencer.instagram_handle %}
                        <a href="https://instagram.com/{{ influencer.instagram_handle }}" target="_blank" class="social-link w-10 h-10 rounded-full bg-light flex items-center justify-center text-primary transition-all duration-300 hover:bg-primary hover:text-white hover:-translate-y-0.5">
                            <i class="fab fa-instagram"></i>
                        </a>
                    {% endif %}
                    {% if influencer.tiktok_handle %}
                        <a href="https://tiktok.com/@{{ influencer.tiktok_handle }}" target="_blank" class="social-link w-10 h-10 rounded-full bg-light flex items-center justify-center text-primary transition-all duration-300 hover:bg-primary hover:text-white hover:-translate-y-0.5">
                            <i class="fab fa-tiktok"></i>
                        </a>
                    {% endif %}
                    {% if influencer.youtube_channel %}
                        <a href="https://youtube.com/{{ influencer.youtube_channel }}" target="_blank" class="social-link w-10 h-10 rounded-full bg-light flex items-center justify-center text-primary transition-all duration-300 hover:bg-primary hover:text-white hover:-translate-y-0.5">
                            <i class="fab fa-youtube"></i>
                        </a>
                    {% endif %}
                    {% if influencer.twitter_handle %}
                        <a href="https://twitter.com/{{ influencer.twitter_handle }}" target="_blank" class="social-link w-10 h-10 rounded-full bg-light flex items-center justify-center text-primary transition-all duration-300 hover:bg-primary hover:text-white hover:-translate-y-0.5">
                            <i class="fab fa-twitter"></i>
                        </a>
                    {% endif %}
                </div>
                {# Added Edit Buttons here #}
                <div class="mt-4 flex gap-4 justify-center md:justify-start"> {# Adjusted margin-top for spacing #}
                    <a href="{% url 'update_influencer_profile' slug=influencer.slug %}"
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Edit Profile
                    </a>
                </div>
            </div>
        </div> 

        <div class="poster-container w-full mb-8 rounded-2xl overflow-hidden shadow-md bg-gray-100">
            {# Poster Image - Optimized for 1280x720 #}
            {% if influencer.poster_pic %}
                <img src="{{ influencer.poster_pic.url }}" 
                    alt="{{ influencer.name }} poster" 
                    class="w-full aspect-video object-contain mx-auto bg-white"
                    loading="lazy">
            {% else %}
                <img src="{% static 'images/default_poster_pic.png' %}" 
                    alt="{{ influencer.name }} poster" 
                    class="w-full aspect-video object-contain mx-auto bg-white"
                    loading="lazy">
            {% endif %}
        </div>

        {# Main Content Sections #}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {# Left Column - Personal Details #}
            <div class="lg:col-span-1 space-y-6">
                {# Personal Details Card #}
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Personal Details</h2>
                    <div class="space-y-4">
                        {% if influencer.full_name %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Full Name:</span>
                            <span class="detail-value">{{ influencer.full_name }}</span>
                        </div>
                        {% endif %}
                        
                        {% if influencer.date_of_birth %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Date of Birth:</span>
                            <span class="detail-value">{{ influencer.date_of_birth }}</span>
                        </div>
                        {% endif %}
                        
                        {% if influencer.place_of_birth %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Place of Birth:</span>
                            <span class="detail-value">{{ influencer.place_of_birth }}</span>
                        </div>
                        {% endif %}
                        
                        {% if influencer.height_cm %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Height:</span>
                            <span class="detail-value">{{ influencer.height_cm }} cm</span>
                        </div>
                        {% endif %}
                        
                        {% if influencer.hair_color %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Hair Color:</span>
                            <span class="detail-value">{{ influencer.hair_color }}</span>
                        </div>
                        {% endif %}
                        
                        {% if influencer.eye_color %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Eye Color:</span>
                            <span class="detail-value">{{ influencer.eye_color }}</span>
                        </div>
                        {% endif %}
                        
                        {% if influencer.education %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Education:</span>
                            <span class="detail-value">{{ influencer.education }}</span>
                        </div>
                        {% endif %}
                        
                        {% if influencer.hobbies %}
                        <div class="detail-item">
                            <span class="detail-label font-medium text-text-light">Hobbies:</span>
                            <span class="detail-value">{{ influencer.hobbies }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {# Assets Card #}
                {% if influencer.assets %}
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Assets</h2>
                    <div class="assets-content">
                        {{ influencer.assets|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>

            {# Middle Column - Main Content #}
            <div class="lg:col-span-2 space-y-6">
                {# Biography Card #}
                {% if influencer.biography %}
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Biography</h2>
                    <div class="biography-content prose max-w-none">
                        {{ influencer.biography|linebreaks }}
                    </div>
                </div>
                {% endif %}

                {# Brand Collaborations Card #}
                {% if influencer.brand_collaborations %}
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Brand Collaborations</h2>
                    <div class="collaborations-content">
                        {{ influencer.brand_collaborations|linebreaks }}
                    </div>
                </div>
                {% endif %}

                {# Media Appearances Card #}
                {% if influencer.media_appearances %}
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Media Appearances</h2>
                    <div class="media-content">
                        {{ influencer.media_appearances|linebreaks }}
                    </div>
                </div>
                {% endif %}

                {# Businesses Card #}
                {% if influencer.businesses %}
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Businesses</h2>
                    <div class="businesses-content">
                        {{ influencer.businesses|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {# Gallery Section #}
        {% if influencer.images.all or influencer.videos.all or influencer.tweets.all %}
        <div class="gallery-section mt-8 bg-white rounded-2xl p-6 shadow-md">
            <h2 class="section-title text-2xl font-semibold mb-5 text-primary">Gallery</h2>
            
            {# Images #}
            {% if influencer.images.all %}
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 text-primary-light">Images</h3>
                {# Adjusted grid for consistent 3 in a row on medium and large screens #}
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4">
                    {% for image in influencer.images.all %}
                    <div class="gallery-item rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300">
                        {# Check if the URL appears to be an Instagram post link #}
                        {% if 'instagram.com/p/' in image.image_url or 'instagram.com/reel/' in image.image_url %}
                            {# Use Instagram's official embed method #}
                            <blockquote class="instagram-media" 
                                        data-instgrm-permalink="{{ image.image_url }}" 
                                        data-instgrm-version="14" 
                                        style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px auto; max-width:540px; min-width:326px; padding:0; width:calc(100% - 2px);">
                                <div style="padding:16px;"> 
                                    <a href="{{ image.image_url }}" rel="noopener" target="_blank"
                                       style=" background:#FFFFFF; line-height:0; padding:0 0; text-align:center; text-decoration:none; width:100%;">
                                        <div style=" display: flex; flex-direction: row; align-items: center;">
                                            {# Instagram embed placeholder content (optional, widgets.js replaces this) #}
                                            <div style="background-color: #F4F4F4; border-radius: 50%; flex-grow: 0; height: 40px; margin-right: 14px; width: 40px;"></div>
                                            <div style="display: flex; flex-direction: column; flex-grow: 1; justify-content: center;"> 
                                                <div style=" background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; margin-bottom: 6px; width: 100px;"></div> 
                                                <div style=" background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; width: 60px;"></div>
                                            </div>
                                        </div>
                                        <div style="padding: 19% 0;"></div> 
                                        <div style="display:block; height:50px; margin:0 auto 12px; width:50px;">
                                            {# SVG for placeholder, will be replaced by Instagram embed #}
                                            <svg height="50px" version="1.1" viewBox="0 0 60 60" width="50px" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
                                                <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1"><g fill="#000000" transform="translate(-511.000000, -20.000000)"><g><path d="M556.869,30.41 C554.814,30.41 553.148,32.076 553.148,34.131 C553.148,36.186 554.814,37.852 556.869,37.852 C558.924,37.852 560.59,36.186 560.59,34.131 C560.59,32.076 558.924,30.41 556.869,30.41 M541,60.657 C535.114,60.657 530.342,55.887 530.342,50 C530.342,44.114 535.114,39.342 541,39.342 C546.887,39.342 551.658,44.114 551.658,50 C551.658,55.887 546.887,60.657 541,60.657 M541,33.886 C532.1,33.886 524.886,41.1 524.886,50 C524.886,58.899 532.1,66.113 541,66.113 C549.9,66.113 557.115,58.899 557.115,50 C557.115,41.1 549.9,33.886 541,33.886 M565.378,62.101 C565.244,65.022 564.756,66.606 564.346,67.663 C563.803,69.06 563.154,70.057 562.106,71.106 C561.058,72.155 560.06,72.803 558.662,73.347 C557.607,73.757 556.021,74.244 553.102,74.378 C549.944,74.521 548.997,74.552 541,74.552 C533.003,74.552 532.056,74.521 528.898,74.378 C525.979,74.244 524.393,73.757 523.338,73.347 C521.94,72.803 520.942,72.155 519.894,71.106 C518.846,70.057 518.197,69.06 517.654,67.663 C517.244,66.606 516.755,65.022 516.623,62.101 C516.479,58.943 516.448,57.996 516.448,50 C516.448,42.003 516.479,41.056 516.623,37.899 C516.755,34.978 517.244,33.391 517.654,32.338 C518.197,30.938 518.846,29.942 519.894,28.894 C520.942,27.846 521.94,27.196 523.338,26.654 C524.393,26.244 525.979,25.756 528.898,25.623 C532.057,25.479 533.004,25.448 541,25.448 C548.997,25.448 549.943,25.479 553.102,25.623 C556.021,25.756 557.607,26.244 558.662,26.654 C560.06,27.196 561.058,27.846 562.106,28.894 C563.154,29.942 563.803,30.938 564.346,32.338 C564.756,33.391 565.244,34.978 565.378,37.899 C565.522,41.056 565.552,42.003 565.552,50 C565.552,57.996 565.522,58.943 565.378,62.101 M570.82,37.631 C570.674,34.438 570.167,32.258 569.425,30.349 C568.659,28.377 567.633,26.702 565.965,25.035 C564.297,23.368 562.623,22.342 560.652,21.575 C558.743,20.834 556.562,20.326 553.369,20.18 C550.169,20.033 549.148,20 541,20 C532.853,20 531.831,20.033 528.631,20.18 C525.438,20.326 523.257,20.834 521.349,21.575 C519.376,22.342 517.703,23.368 516.035,25.035 C514.368,26.702 513.342,28.377 512.574,30.349 C511.834,32.258 511.326,34.438 511.181,37.631 C511.035,40.831 511,41.851 511,50 C511,58.147 511.035,59.17 511.181,62.369 C511.326,65.562 511.834,67.743 512.574,69.651 C513.342,71.625 514.368,73.296 516.035,74.965 C517.703,76.634 519.376,77.658 521.349,78.425 C523.257,79.167 525.438,79.673 528.631,79.82 C531.831,79.965 532.853,80.001 541,80.001 C549.148,80.001 550.169,79.965 553.369,79.82 C556.562,79.673 558.743,79.167 560.652,78.425 C562.623,77.658 564.297,76.634 565.965,74.965 C567.633,73.296 568.659,71.625 569.425,69.651 C570.167,67.743 570.674,65.562 570.82,62.369 C570.966,59.17 571,58.147 571,50 C571,41.851 570.966,40.831 570.82,37.631"></path></g></g></g></svg>
                                        </div>
                                        <div style="padding-top: 8px;"> 
                                            <div style=" color:#3897f0; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:550; line-height:18px;">View this post on Instagram</div>
                                        </div>
                                        <div style="padding: 12.5% 0;"></div> 
                                        <div style="display: flex; flex-direction: row; margin-bottom: 14px; align-items: center;">
                                            <div> 
                                                <div style="background-color: #F4F4F4; border-radius: 50%; height: 12.5px; width: 12.5px; transform: translateX(0px) translateY(7px);"></div> 
                                                <div style="background-color: #F4F4F4; height: 12.5px; transform: rotate(-45deg) translateX(3px) translateY(1px); width: 12.5px; flex-grow: 0; margin-right: 14px; margin-left: 2px;"></div> 
                                                <div style="background-color: #F4F4F4; border-radius: 50%; height: 12.5px; width: 12.5px; transform: translateX(9px) translateY(-18px);"></div>
                                            </div>
                                            <div style="margin-left: 8px;"> 
                                                <div style=" background-color: #F4F4F4; border-radius: 50%; flex-grow: 0; height: 20px; width: 20px;"></div> 
                                                <div style=" width: 0; height: 0; border-top: 2px solid transparent; border-left: 6px solid #f4f4f4; border-bottom: 2px solid transparent; transform: translateX(16px) translateY(-4px) rotate(30deg)"></div>
                                            </div>
                                            <div style="margin-left: auto;"> 
                                                <div style=" width: 0px; border-top: 8px solid #F4F4F4; border-right: 8px solid transparent; transform: translateY(16px);"></div> 
                                                <div style=" background-color: #F4F4F4; flex-grow: 0; height: 12px; width: 16px; transform: translateY(-4px);"></div> 
                                                <div style=" width: 0; height: 0; border-top: 8px solid #F4F4F4; border-left: 8px solid transparent; transform: translateY(-4px) translateX(8px);"></div>
                                            </div>
                                        </div> 
                                        <div style="display: flex; flex-direction: column; flex-grow: 1; justify-content: center; margin-bottom: 24px;"> 
                                            <div style=" background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; margin-bottom: 6px; width: 224px;"></div> 
                                            <div style=" background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; width: 144px;"></div>
                                        </div>
                                    </a>
                                    <p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;">
                                        <a href="{{ image.image_url }}" rel="noopener" target="_blank"
                                           style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;">
                                            A post shared by Buse İskenderoğlu (@buseiskenderoglu) {# This part needs to be dynamic or a generic fallback #}
                                        </a>
                                    </p>
                                </div>
                            </blockquote> 
                            {# Instagram's embed.js should be loaded ONCE per page, preferably at the very end of <body> #}
                            {# Placing it here will load it multiple times, which is inefficient. #}
                            {# It is recommended to move this script to your base template's </body> tag if possible. #}
                            {# <script async src="//www.instagram.com/embed.js"></script> #} {# REMOVED FROM HERE #}

                        {% else %}
                            {# Default to showing as a regular image if it's not an Instagram post URL #}
                            <img src="{{ image.image_url }}" 
                                 alt="{{ image.caption|default:'Influencer image' }}" 
                                 class="w-full h-48 object-cover rounded-t-lg"
                                 onerror="this.onerror=null; this.src='https://placehold.co/400x300/e0e0e0/555555?text=Image+Not+Found';">
                        {% endif %}

                        {% if image.caption %}
                        <div class="p-3 bg-gray-50">
                            <p class="text-sm text-gray-700">{{ image.caption }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {# Videos #}
            {% if influencer.videos.all %}
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 text-primary-light">Videos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> {# Adjusted to 3 cols for larger screens #}
                    {% for video in influencer.videos.all %}
                    <div class="video-item rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300">
                        {% if video.source == 'youtube' %}
                            {# YouTube embed #}
                            {# Ensure 'youtube_id' filter correctly extracts ID from URL #}
                            <iframe src="https://www.youtube.com/embed/{{ video.video_url|youtube_id }}" 
                                    class="w-full h-64" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                    onerror="this.onerror=null; this.src='https://placehold.co/400x300/e0e0e0/555555?text=YouTube+Embed+Failed';"></iframe>
                        {% elif video.source == 'instagram' %}
                            {# Instagram Video Embed - Use blockquote if it's a post, not just an iframe #}
                            {# Similar to images, full Instagram posts (which can be videos) are embedded with blockquotes #}
                            {# If video_url is a reel/post link, the same Instagram embed.js handles it. #}
                            <blockquote class="instagram-media" 
                                        data-instgrm-permalink="{{ video.video_url }}" 
                                        data-instgrm-version="14" 
                                        style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px auto; max-width:540px; min-width:326px; padding:0; width:calc(100% - 2px);">
                                <div style="padding:16px;"> 
                                    <a href="{{ video.video_url }}" rel="noopener" target="_blank"
                                       style=" background:#FFFFFF; line-height:0; padding:0 0; text-align:center; text-decoration:none; width:100%;">
                                        {# Placeholder content similar to image embed #}
                                        <div style=" display: flex; flex-direction: row; align-items: center;">
                                            <div style="background-color: #F4F4F4; border-radius: 50%; flex-grow: 0; height: 40px; margin-right: 14px; width: 40px;"></div>
                                            <div style="display: flex; flex-direction: column; flex-grow: 1; justify-content: center;"> 
                                                <div style=" background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; margin-bottom: 6px; width: 100px;"></div> 
                                                <div style=" background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; width: 60px;"></div>
                                            </div>
                                        </div>
                                        <div style="padding: 19% 0;"></div> 
                                        <div style="display:block; height:50px; margin:0 auto 12px; width:50px;">
                                            <svg height="50px" version="1.1" viewBox="0 0 60 60" width="50px" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">...</svg> {# Simplified SVG #}
                                        </div>
                                        <div style="padding-top: 8px;"> 
                                            <div style=" color:#3897f0; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:550; line-height:18px;">View this video on Instagram</div>
                                        </div>
                                        <div style="padding: 12.5% 0;"></div> 
                                        {# More placeholder content #}
                                    </a>
                                    <p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;">
                                        <a href="{{ video.video_url }}" rel="noopener" target="_blank"
                                           style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;">
                                            A video by {{ influencer.name }}
                                        </a>
                                    </p>
                                </div>
                            </blockquote>
                            {# Instagram's embed.js is now loaded once at the end of the block #}
                        {% else %}
                            {# Fallback for other video sources or if embed fails #}
                            <div class="w-full h-64 bg-gray-200 flex items-center justify-center">
                                <a href="{{ video.video_url }}" target="_blank" class="text-primary">View on {{ video.source|capfirst }}</a>
                            </div>
                        {% endif %}
                        {% if video.caption %}
                        <div class="p-3 bg-light">
                            <p class="text-sm text-text">{{ video.caption }}</p>
                            <p class="text-xs text-text-light mt-1">Source: {{ video.get_source_display }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
        </div>
        {% endif %}

        {# Achievements & Controversies Section #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            {% if influencer.achievements %}
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Achievements</h2>
                <div class="achievements-content">
                    {{ influencer.achievements|linebreaks }}
                </div>
            </div>
            {% endif %}
            
            {% if influencer.controversies %}
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h2 class="section-title text-2xl font-semibold mb-5 text-primary border-b pb-2">Controversies</h2>
                <div class="controversies-content">
                    {{ influencer.controversies|linebreaks }}
                </div>
            </div>
            {% endif %}
        </div>

    <div class="community-section bg-white rounded-2xl p-6 shadow-md">
        <h2 class="section-title text-2xl font-semibold mb-5 text-primary">Community Chat</h2>

        <!-- Chat container -->
        <div class="chat-container h-[600px] overflow-y-auto pr-2" id="chat-container">
            {% for post in posts %}
                {% include "influencer/_community_post.html" with post=post %}
            {% empty %}
                <p class="text-text-light">No community messages yet. Be the first to post!</p>
            {% endfor %}
        </div>

        <!-- New top-level post form -->
        <div class="chat-input-container flex gap-4 mt-4">
            {% if user.is_authenticated %}
                {% if post.user.userprofile.profile_picture %}
                    <img src="{{ post.user.userprofile.profile_picture.url }}" 
                        alt="{{ post.user.username }}" 
                        class="message-avatar {% if post.parent %}w-7 h-7{% else %}w-9 h-9{% endif %} rounded-full object-cover mr-2">
                {% else %}
                    <img src="{% static 'images/default_profile.png' %}" 
                        alt="{{ post.user.username }}" 
                        class="message-avatar {% if post.parent %}w-7 h-7{% else %}w-9 h-9{% endif %} rounded-full object-cover mr-2">
                {% endif %}
                <form method="POST" class="top-post-form flex-1 flex" data-parent="">
                    {% csrf_token %}
                    <input type="hidden" name="parent" value="">
                    <input type="text" name="content" placeholder="Write a new message..."
                        class="flex-1 px-5 py-3 bg-light border border-primary-light rounded-full text-base text-text focus:outline-none focus:border-primary">
                    <button type="submit" class="chat-send w-12 h-12 rounded-full bg-primary text-white border-none flex items-center justify-center ml-3 hover:bg-highlight">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            {% else %}
                <p class="text-text-light text-sm ml-3">
                    <a href="{% url 'account_login' %}" class="text-primary hover:underline">Login</a> or 
                    <a href="{% url 'account_signup' %}" class="text-primary hover:underline">Signup</a> to join the community chat.
                </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- JS: Toggle replies + AJAX form submission -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chat-container');

    // Event delegation for toggling reply forms
    chatContainer.addEventListener('click', function(e) {
        const toggle = e.target.closest('.toggle-reply');
        if (toggle) {
            e.preventDefault();
            const postId = toggle.dataset.postId;
            const form = document.getElementById(`reply-form-${postId}`);
            if (form) {
                form.classList.toggle('hidden');
                const input = form.querySelector('input[name="content"]');
                if (input) input.focus();
            }
        }
    });

    // AJAX form submission
    function ajaxFormSubmit(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const url = window.location.href;
            const formData = new FormData(form);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.is_reply) {
                        // Append reply to parent post
                        const parentPost = document.getElementById(`post-${data.parent_id}`);
                        parentPost.insertAdjacentHTML('beforeend', data.html);
                        parentPost.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    } else {
                        // Append new top-level post
                        chatContainer.insertAdjacentHTML('beforeend', data.html);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                    // Reset the form
                    form.reset();
                    form.closest('.reply-form-container')?.classList.add('hidden');
                } else {
                    // Show friendly message for guests
                    alert(data.error || 'Login or signup to post in the community.');
                }
            })
            .catch(err => {
                console.error('Error posting message:', err);
                alert('An error occurred. Please try again.');
            });
        });
    }

    // Attach AJAX to all existing forms
    document.querySelectorAll('.reply-form, .top-post-form').forEach(ajaxFormSubmit);

    // Optional: Observe for new forms being added dynamically
    const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            mutation.addedNodes.forEach(node => {
                if (node.nodeType === 1) { // Element node
                    node.querySelectorAll('.reply-form').forEach(ajaxFormSubmit);
                }
            });
        });
    });

    observer.observe(chatContainer, { childList: true, subtree: true });
});
</script>


    {# GLOBAL JAVASCRIPT FOR EMBEDS - Loaded once at the end of the content block #}
    {# Instagram embed script #}
    <script async src="//www.instagram.com/embed.js"></script>
{% endblock %}
